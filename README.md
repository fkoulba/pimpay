# Pimpay

## Задача 1 (SQL)

Есть в БД (PostgreSQL) таблица c клиентами с уникальными ИНН:

CREATE TABLE tbl_customer
(
id BIGINT NOT NULL, -- Клиент
tin VARCHAR NOT NULL UNIQUE – Уникальный ИНН клиента
)

Также есть таблица, хранящая денежные проводки по займам клиентов:

CREATE TABLE tbl_loan_transaction
(
customer_id BIGINT NOT NULL, -- Клиент, FK на tbl_customer(id)
type VARCHAR NOT NULL, -- Тип транзакции
amount NUMERIC(10,2) NOT NULL -- Сумма
)

Пример выборки из таблицы:

customer_id | type | amount
------------|------|-------
3435 | loan | 1000.50
3435 | interest | 1.50
3435 | interest_repayment | 1.50
3435 | loan | 7800.00
4456 | loan_repayment | 5200.30

Тип транзакции | Расшифровка
---------------|------------
loan | Выдача займа
loan_repayment | Погашение основного тела займа
interest | Начисление процентов по займу
interest_repayment | Погашение процентов

Бизнес оперирует понятием «кредитный портфель», который считается по следующей формуле:

Портфель = ∑(loan) - ∑(loan_repayment) + ∑(interest) - ∑(interest_repayment)

**Задача:** Напишите SQL запрос, который отображает кредитный портфель по каждому клиенту в
порядке убывания портфеля, за исключением клиентов у которых нулевой портфель. Также
вывести столбец , показывающий какой процент от общего портфеля составляет каждый клиент.

Пример результата такого запроса:

tin | portfolio | %
----|-----------|--
23581783732 | 4000.25 | 79.8%
23581783732 | 1000.70 | 20%
59380919099 | 12.00 | 0.2%

Дополнительный бонус: Не использовать при решении данной задачи подзапросы, CTE, доп.
таблицы/представления, хранимые процедуры.

## Задача 2 (PHP)

Напишите PHP код по работе с иммутабельными вычислениями денежных значений с учётом
валют. Требования: возможность складывать/вычитать/умножать числа и валюты с сохранением
цепочки вычислений, чтобы потом можно было описать формулу/схлопнуть/подставить
котировки.

Для целей упражнения будем работать только с двумя валютами RUB и USD.

Клиентский php-код, в который **нельзя** вносить изменения:

```php
$expr = ( RUB(10) ->mul(5) ->add(USD(5)) -> sub(RUB(3)) ) ->mul(2);
$expr->describe(); // возвращает строку '((10RUB) * 5 + 5USD - 3RUB) * 2'
$expr->collapse(); // возвращает массив ['RUB' => 94, 'USD' => 10]
$expr->asFloat(['RUB' => 1, 'USD' => 63.23]); // возвращает 726.3
```

Дополнительный бонус: Решить данную задачу без использования массивов и подобных
объектов (итераторов, генераторов, ArrayAccess, SPL) и циклов (также библиотечных функций для
итераций вида array_reduce и т.п.)
